---
title: "Yours in the Fantasy Analysis: Better Late Than Never"
author: "Luke Wilson"
output: html_document
---

# Week `r REPORTNO`

[Week 1](https://lvzwilson1.github.io/weekly_report_1.html)
[Week 2](https://lvzwilson1.github.io/weekly_report_2.html)
[Week 3](https://lvzwilson1.github.io/weekly_report_3.html)
[Week 4](https://lvzwilson1.github.io/weekly_report_4.html)
[Week 5](https://lvzwilson1.github.io/weekly_report_5.html)
[Week 6](https://lvzwilson1.github.io/weekly_report_6.html)
[Week 7](https://lvzwilson1.github.io/weekly_report_7.html)
[Week 8](https://lvzwilson1.github.io/weekly_report_8.html)
[Week 9](https://lvzwilson1.github.io/weekly_report_9.html)
[Week 10](https://lvzwilson1.github.io/index.html)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.align = 'center')
```


```{r data_import, include=FALSE}
## Filter down each data set into the appropriate subset of 

keep(dat.MASTER,     leagueDat.MASTER, playerscoresDat.MASTER, 
     lineUps.MASTER, all.sched.MASTER, thisWeek, REPORTNO, rMarkdownWeeklyScript,
     sure = TRUE)

currentWeek     <- REPORTNO

leagueDat       <- leagueDat.MASTER       

dat             <- dat.MASTER             %>% filter(week <= currentWeek)
lineUps         <- lineUps.MASTER         %>% filter(week <= currentWeek)
playerscoresDat <- playerscoresDat.MASTER %>% filter(week <= currentWeek)

leagueDatttt <- leagueDat %>% rename(teamID=ID)

all.sched <- all.sched.MASTER %>% filter(week <= currentWeek)

## collapse results at schedule level
allSchedSum <- all.sched %>% group_by(nschedule, teamID) %>% 
  summarize(nWins = sum(winner)) %>% ungroup %>% mutate(count = 1)

## collapse results at team level
allResults <- allSchedSum %>% group_by(teamID, nWins) %>%
  summarise(nResults = sum(count)) %>% merge(leagueDatttt)


```

## Total Wins Approach

This approach sums, for each week, how many other teams you would have beaten. A team's expected win percentage is then calculated as the number of actual possible wins, divided by the maximum number of possible wins possible, 9*number of weeks.


```{r total_week_wins, include=FALSE}
############################ x
### Checking Total Week Wins
############################ x  

head(dat) 
datWeekWins <- dat %>% group_by(week) %>% 
  mutate(nwins = order(order(points, decreasing = FALSE))-1) %>%
  ungroup %>% group_by(owner) %>% summarise(weekwins = sum(nwins), wins = sum(winner)) %>%
  mutate(potentialWins = currentWeek*9, expectedWins = (weekwins/potentialWins)*currentWeek) %>%
  mutate(diference = wins - expectedWins) %>%
  select(-c(potentialWins)) %>%
  mutate(expectedWins = round(expectedWins, 2), diference = round(diference, 2)) %>%
  arrange(desc(expectedWins))
names(datWeekWins) <-  c("Team", "Week Wins", "Actual Wins", "Expected Wins", "Actual Wins - Expected Wins")

```

```{r week_wins, echo=FALSE}
  DT::datatable(datWeekWins, options = list(dom = 't'), rownames = F)
```

## Pythagorean Wins Analysis

```{r pythagorean_analysis, include=FALSE}
butme <- function(x, team) {
  x %>%
    group_by(owner) %>% 
    summarize(pf = sum(points)) %>%
    filter(owner != team) -> .
  return(as.numeric(mean(.$pf)))
}

## create dataframe of average of teams except for a team's points for
teams <- unique(dat$owner)
against.proxy <- vector(length = length(teams))

for (i in 1:length(teams)) {
  against.proxy[i] <- butme(dat, teams[i])
}

f = 13.91

againstProxies <- data.frame(owner = teams, proxy= against.proxy)
pyThagStats <- dat %>% group_by(owner) %>% summarize(points = sum(points), wins = sum(winner)) %>% 
  merge(againstProxies) %>%
  mutate(winratio = points^f/(points^f + proxy^f)) %>%
  mutate(expectedWins = winratio*currentWeek) %>%
  mutate(difference = wins - expectedWins) %>%
  select(-c(points, proxy, winratio)) %>%
  mutate(expectedWins = round(expectedWins, 2), difference = round(difference, 2)) %>%
  arrange(desc(expectedWins))
names(pyThagStats) <- c("Team", "Actual Wins", "Expected Wins", "Actual Wins - Expected Wins")

rm(againstProxies)
```

This analysis tries to calculate expected wins as a function of points for, and a proxy for points against. The exponent used is `r f`.


```{r allscheds3, echo=FALSE}
  DT::datatable(pyThagStats, options = list(dom = 't'), rownames = F)
```


## All Schedules Simulated

Our league is setup so that each team plays each of the other 9 teams once during the first 9 weeks of the season, and then replays the first 4 teams they played. There are 362,880 such possible schedules. 

```{r simulate_all_schedules, include=FALSE}
############################ x
### Simulate All Schedules Analysis
############################ x 

forMerge <- leagueDat %>% select(-c(fullname))
allResults <- allResults %>% select(-c(fullname)) %>% merge(forMerge)

# faceted histogram of wins

betterName <- ggplot(allResults, aes(x=nWins, y =nResults)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~owner, ncol = 2)

## max/min table
maxMinTable <- allResults %>%
  group_by(owner) %>%
  summarise(minWins = min(nWins), maxWins = max(nWins)) %>%
  merge(allResults) %>%
  filter(nWins == minWins | nWins == maxWins) %>%
  mutate(minOrMax = ifelse(nWins == minWins, "min", "max")) %>%
  select(-c(nWins, teamID, ID, teamID)) %>%
  reshape(timevar = "minOrMax", idvar = c("owner", "minWins", "maxWins"), direction = "wide") %>%
  arrange(desc(maxWins),desc(nResults.max))
names(maxMinTable) <-  c("Team", "Min Wins Possible", "Max Wins Possible", "# Min", "# Max")

rm(allResults)
```

### Distribution of Wins over All Potential Schedules


```{r betterName, echo=FALSE}
  print(betterName)
```

### Max and Min Wins Possible

This table shows, for each team, the maximum number of wins and the minimum number of wins that each team could have achieved over all possible schedules. It also shows out of the 362880 possible schedules, how many times a team achieves that number of wins. 

```{r max_min_table, echo=FALSE}
  DT::datatable(maxMinTable, options = list(dom = 't'), rownames = F)
```


## Start/Sit Efficiency Analysis

```{r start_sit_analysis, include=FALSE}

############################ x
### Start sit analysis
############################ x

## Analysis
# Total Lost Points and average maxscore
merged2 <- lineUps %>% mutate(lostPoints = ActualMax - points) %>% group_by(owner) %>% 
  summarise(lostPoints = sum(lostPoints), avgOpt = mean(ActualMax), avgPoints = mean(points)) %>% mutate(lostPoints = lostPoints/currentWeek) %>%
  mutate(lostPoints = round(lostPoints, 2), avgOpt = round(avgOpt, 2), avgPoints = round(avgPoints, 2)) %>%
  arrange(lostPoints)
names(merged2) <- c("Team", "Average Lost Points", "Average Optimal Points", "Average Points")

# Who has perfect weeks?
perfectWeeks = lineUps %>% filter(ActualMax == points) 

# Barbell plot
dattt <- lineUps %>%  
  group_by(owner) %>% summarise(avgPoints = mean(points), avgOpt = mean(ActualMax)) %>% 
  arrange(desc(avgPoints))
dattt$owner <- factor(dattt$owner, levels=as.character(dattt$owner)) 

gg <- ggplot(dattt, aes(x=avgPoints, xend=avgOpt, y=owner, group=owner)) + 
  geom_dumbbell(color="#a3c4dc", 
                size=2,
                colour_x = "blue",
                colour_xend = "blue",
                show.legend = TRUE) + 
  labs(x=NULL, 
       y=NULL, 
       title="Average Actual Points vs. Possible Points")  +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        plot.background=element_rect(fill="#f7f7f7"),
        panel.background=element_rect(fill="#f7f7f7"),
        panel.grid.minor=element_blank(),
        panel.grid.major.y=element_blank(),
        panel.grid.major.x=element_line(),
        axis.ticks=element_blank(),
        legend.position="top",
        panel.border=element_blank())

# Optimal Lineup records
oppLineUps <- lineUps %>% select(week, ID, ActualMax) %>% rename(oppID = ID, oppMaxScore = ActualMax) 
mergdOppScore <- lineUps %>% inner_join(oppLineUps) %>% mutate(optWinner = ifelse(ActualMax > oppMaxScore, 1, 0)) %>%
  group_by(owner) %>% summarize(winsOptimal = sum(optWinner), actualWins = sum(winner)) %>%
  mutate(difference = winsOptimal - actualWins)
names(mergdOppScore) <- c("Team", "Optimal Lineup Wins", "Actual Wins", "Optimal - Actual Wins")
```

### Optimal Records

This table contains each teams records if they and their opponent played their optimal lineups each week. 

```{r optimal_wins, echo=FALSE}
  DT::datatable(mergdOppScore, options = list(dom = 't'), rownames = F)
```

### Average Points Left on Bench

```{r optimal_wins_table, echo=FALSE}
  DT::datatable(merged2, options = list(dom = 't'), rownames = F)
```

```{r barbell_plot, echo=FALSE}
  print(gg)
```

## Actuals vs Projections

This section of analysis concerns projections.

```{r actual_vs_projection, echo=FALSE}

ratingsWhores <- lineUps %>% mutate(espnVsOwner = if_else(points == ProjScore, "Equal to ESPN", 
                                                  if_else(points > ProjScore, "Beat ESPN", "ESPN Better"))) %>%
  mutate(count = 1) %>% group_by(owner, espnVsOwner) %>% summarise(nTimes = sum(count)) %>% 
  spread(espnVsOwner, nTimes) %>% 
  mutate(`Equal to ESPN` = ifelse(is.na(`Equal to ESPN`),0,`Equal to ESPN`),
         `Beat ESPN`     = ifelse(is.na(`Beat ESPN`),    0,`Beat ESPN`),
         `ESPN Better`   = ifelse(is.na(`ESPN Better`),  0,`ESPN Better`))  %>%
  arrange(desc(`Equal to ESPN`)) %>%
  rename(Team = owner) 

espnVsOwner <- lineUps %>% 
  group_by(owner) %>% summarize(espnWins = sum(espnWinner), ownerWins = sum(winner)) %>% 
  mutate(difference = espnWins - ownerWins) %>% arrange(desc(difference))
names(espnVsOwner) <- c("Team", "ESPN Wins", "Actual Wins", "ESPN - Actual Wins")

# Barbell plot
dattt <- lineUps %>% 
  group_by(owner) %>% summarise(avgPoints = mean(points), avgESPN = mean(ProjScore)) %>% 
  arrange(desc(avgPoints))
dattt$owner <- factor(dattt$owner, levels=as.character(dattt$owner)) 

gg <- ggplot(dattt, aes(x=avgPoints, xend=avgESPN, y=owner, group=owner)) + 
  geom_dumbbell(color="#a3c4dc", 
                size=2,
                colour_x = "blue",
                colour_xend = "red",
                show.legend = TRUE) + 
  labs(x=NULL, 
       y=NULL, 
       title="Owner Linups (Blue) vs. ESPN Lineups (Red)")  +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        plot.background=element_rect(fill="#f7f7f7"),
        panel.background=element_rect(fill="#f7f7f7"),
        panel.grid.minor=element_blank(),
        panel.grid.major.y=element_blank(),
        panel.grid.major.x=element_line(),
        axis.ticks=element_blank(),
        legend.position="top",
        panel.border=element_blank())

```


### Lineup Skill

This plot contains the average score of the user set lineup, and the average score of the lineup that was projected by ESPN to score the most each week. 

```{r barbell_plot_espn, echo=FALSE}
  print(gg)
```

This table contains each owners record if they started the lineup that was projected by ESPN to score the most each week.

```{r espnVsOwner, echo=FALSE}
  DT::datatable(espnVsOwner, options = list(dom = 't'), rownames = F)
```

### Who Follows Projections?

This table containst the number of times that each team played the lineup that was projected by ESPN to score the most each week.

```{r ratingsWhores, echo=FALSE}
  DT::datatable(ratingsWhores, options = list(dom = 't'), rownames = F)
```


## Positional Strengths and Weaknesses

### Average Points by Position and Team

Note that a teams WR1/RB1 is the WR/RB each week that scored the most points. 

```{r positional_strength, echo=FALSE}

actualScores <- playerscoresDat %>% filter(slotID == possSlots & slotID != 20) %>%
  arrange(ID, slotID, week, desc(points)) %>% group_by(week, ID, slotID) %>% mutate(posNum = seq_along(points)) %>%
  ungroup %>% group_by(ID, slotID, posNum) %>% summarise(avgPoints = mean(points)) %>%
  inner_join(leagueDat, by = "ID") %>%
  mutate(position = ifelse(slotID == 2 & posNum == 1, "RB1", ifelse(slotID == 2 & posNum == 2, "RB2",
                    ifelse(slotID == 4 & posNum == 1, "WR1", ifelse(slotID == 4 & posNum == 2, "WR2",
                    ifelse(slotID == 0, "QB",                ifelse(slotID == 6,  "TE",
                    ifelse(slotID == 16, "DST",              ifelse(slotID == 17, "K",
                    ifelse(slotID == 23, "FLEX", "")))))))))) %>% 
  ungroup %>% select(c(owner, position, avgPoints)) %>%
  group_by(position) %>% mutate(avgPosPoints = mean(avgPoints)) %>%
  mutate(pointsOverAvg = round(100*(avgPoints - avgPosPoints)/avgPosPoints,0))

pointsByPosTab <- actualScores %>%
  select(c(owner, position, avgPoints)) %>%
  mutate(avgPoints = round(avgPoints, 2)) %>%
  spread(position, avgPoints) %>%
  rename(Owner = owner) %>%
  mutate(Total = QB+WR1+WR2+RB1+RB2+TE+DST+K+FLEX) %>%
  arrange(desc(Total))
  
maxValue <- max(abs(actualScores$pointsOverAvg))

ggg <- ggplot(actualScores, aes(owner, position, fill = pointsOverAvg)) + 
  geom_tile(colour = "white") + 
  geom_text(aes(label=pointsOverAvg)) +
  scale_fill_gradientn(colors=c("red","white","green"),
                       values=rescale(c(-maxValue,0,maxValue)),
                       limits=c(-maxValue,maxValue)) +
  labs(x="Owner", y="Percent Above Average in League",
       title = "Points by Position", fill = "")

```


```{r pointsByPosTab, echo=FALSE}
  DT::datatable(pointsByPosTab, options = list(dom = 't'), rownames = F)
```

## Points Above Average by Position

```{r points_by_pos, echo=FALSE}
  print(ggg)
```

